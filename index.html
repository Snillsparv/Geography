<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sydamerika – Forma-spelet</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f1b2d;
      color: #e0e0e0;
      min-height: 100vh;
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #1a2940, #2a4060);
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }

    header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: #5bbfff;
    }

    .header-hint {
      color: #6a8eab;
      font-size: 0.85rem;
    }

    .game-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* ── Map panel ── */
    .map-panel {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .map-wrapper {
      position: relative;
      max-height: 100%;
      cursor: grab;
      transform-origin: center center;
      transition: transform 0.18s ease-out;
    }

    .map-wrapper.dragging {
      cursor: grabbing;
      transition: none !important;
    }

    .map-wrapper img.base-map {
      max-height: calc(100vh - 96px);
      width: auto;
      display: block;
      filter: brightness(2) saturate(0) contrast(0.6) brightness(1.8);
      transition: filter 0.4s;
    }

    /* Zoom controls */
    .zoom-controls {
      position: absolute;
      bottom: 24px;
      left: 24px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }

    .zoom-btn {
      width: 38px;
      height: 38px;
      background: rgba(22, 34, 53, 0.9);
      border: 1px solid rgba(91,191,255,0.2);
      border-radius: 8px;
      color: #5bbfff;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      user-select: none;
    }

    .zoom-btn:hover {
      background: rgba(42, 64, 96, 0.95);
      border-color: rgba(91,191,255,0.5);
    }

    .zoom-level {
      text-align: center;
      font-size: 0.7rem;
      color: #4a6a82;
      padding: 2px 0;
      user-select: none;
    }

    .country-overlay {
      position: absolute;
      transition: opacity 0.4s ease;
      opacity: 0;
      pointer-events: none;
    }

    .country-overlay.visible {
      opacity: 1;
    }

    /* Hover highlight canvas */
    #hit-canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .hover-highlight {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      mix-blend-mode: screen;
      filter: brightness(0.5) sepia(1) hue-rotate(170deg) saturate(3) brightness(0.7);
    }

    .hover-highlight.active {
      opacity: 0.4;
    }

    /* ── Info panel ── */
    .info-panel {
      width: 380px;
      background: linear-gradient(180deg, #162235, #1a2a42);
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 20px rgba(0,0,0,0.3);
      overflow-y: auto;
    }

    .info-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .info-header h2 {
      font-size: 1rem;
      color: #5a8aaa;
      font-weight: 500;
    }

    /* Default state – no country selected */
    .info-default {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      text-align: center;
      color: #4a6a82;
    }

    .info-default .arrow-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .info-default p {
      font-size: 1rem;
      line-height: 1.6;
    }

    /* Country info card */
    .info-card {
      display: none;
      flex-direction: column;
      padding: 24px;
      gap: 16px;
      animation: slideIn 0.3s ease;
    }

    .info-card.active {
      display: flex;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .info-card .country-name {
      font-size: 1.6rem;
      font-weight: 700;
      color: #5bbfff;
    }

    .info-card .country-shape-preview {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(91,191,255,0.1);
      border-radius: 12px;
    }

    .info-card .country-shape-preview img {
      max-width: 90%;
      max-height: 160px;
      object-fit: contain;
    }

    .info-card .description {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #b0c8d8;
    }

    .info-card .close-hint {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #4a6a82;
      text-align: center;
    }

    /* Counter */
    .counter {
      padding: 16px 24px;
      border-top: 1px solid rgba(255,255,255,0.06);
      color: #5a8aaa;
      font-size: 0.85rem;
      text-align: center;
      margin-top: auto;
    }

    .counter strong {
      color: #5bbfff;
    }

    /* ── Responsive ── */
    @media (max-width: 900px) {
      body { overflow: auto; }
      .game-container {
        flex-direction: column;
        height: auto;
      }
      .map-panel {
        height: 50vh;
        min-height: 300px;
      }
      .map-wrapper img.base-map {
        max-height: 46vh;
      }
      .info-panel {
        width: 100%;
        min-height: 50vh;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Sydamerika – Forma-spelet</h1>
  <span class="header-hint">Klicka på ett land för att utforska det</span>
</header>

<div class="game-container">
  <div class="map-panel">
    <div class="map-wrapper" id="map-wrapper">
      <img class="base-map" id="base-map" src="assets/map.png" alt="Sydamerika karta">
      <!-- Overlays injected by JS -->
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoom-in" title="Zooma in">+</button>
      <div class="zoom-level" id="zoom-level">100%</div>
      <button class="zoom-btn" id="zoom-out" title="Zooma ut">&minus;</button>
    </div>
  </div>

  <div class="info-panel">
    <div class="info-header">
      <h2>Landinformation</h2>
    </div>

    <div class="info-default" id="info-default">
      <div class="arrow-icon">&larr;</div>
      <p>Klicka på ett land på kartan<br>för att se dess form och<br>läsa om det!</p>
    </div>

    <div class="info-card" id="info-card">
      <div class="country-name" id="info-name"></div>
      <div class="country-shape-preview">
        <img id="info-shape" src="" alt="">
      </div>
      <div class="description" id="info-desc"></div>
      <div class="close-hint">Klicka på landet igen för att dölja</div>
    </div>

    <div class="counter" id="counter">
      Utforskade: <strong id="explored-count">0</strong> / <strong>13</strong> länder
    </div>
  </div>
</div>

<script>
const COUNTRIES = [
  {
    name: "Argentina",
    filename: "argentina",
    left: 1507, top: 2150, width: 985, height: 2130, centerX: 1999, centerY: 3215,
    desc: "Argentina är Sydamerikas näst största land och sträcker sig från subtropiska norra regioner ner till det iskalla Patagonien. Landet är känt för tango, biff, och fotbollslegenden Maradona. Huvudstaden Buenos Aires kallas ofta \"Sydamerikas Paris\"."
  },
  {
    name: "Chile",
    filename: "chile",
    left: 1391, top: 1950, width: 524, height: 2375, centerX: 1653, centerY: 3137,
    desc: "Chile är världens smalaste land och sträcker sig över 4 300 km längs Sydamerikas västkust. Landets unika form ger det en otrolig variation – från Atacamaöknen i norr (världens torraste plats) till glaciärer i söder."
  },
  {
    name: "Uruguay",
    filename: "uruguay",
    left: 2165, top: 2689, width: 271, height: 327, centerX: 2300, centerY: 2852,
    desc: "Uruguay är ett av Sydamerikas minsta länder men rankas ofta högst i demokrati och levnadsstandard. Det lilla landet mellan Argentina och Brasilien vann den första fotbolls-VM-finalen 1930 på hemmaplan."
  },
  {
    name: "Paraguay",
    filename: "paraguay",
    left: 1947, top: 1916, width: 539, height: 613, centerX: 2216, centerY: 2222,
    desc: "Paraguay är ett av bara två landlåsta länder i Sydamerika. Floden Paraguay delar landet i två helt olika halvor – det gröna östlandet och den vilda, glest befolkade Chaco-regionen i väst."
  },
  {
    name: "Brasilien",
    filename: "brasilien",
    left: 1113, top: 420, width: 2511, height: 2488, centerX: 2368, centerY: 1664,
    desc: "Brasilien är Sydamerikas gigant och täcker nästan halva kontinenten. Landet rymmer Amazonas regnskog – jordens \"lunga\" – och är världens femte största land. Karnevalen i Rio och fotboll är en del av själen."
  },
  {
    name: "Bolivia",
    filename: "bolivia",
    left: 1240, top: 1035, width: 1076, height: 1250, centerX: 1778, centerY: 1660,
    desc: "Bolivia är Sydamerikas andra landlåsta land och hem till Salar de Uyuni – världens största saltöken. Huvudstaden La Paz ligger på över 3 600 meters höjd, vilket gör den till en av världens högst belägna huvudstäder."
  },
  {
    name: "Peru",
    filename: "peru",
    left: 632, top: 768, width: 856, height: 1238, centerX: 1060, centerY: 1387,
    desc: "Peru var hjärtat av Inkariket och hem till den legendariska Machu Picchu. Landet har tre distinkta zoner: den torra kusten, de mäktiga Anderna och Amazonas regnskog i öster."
  },
  {
    name: "Ecuador",
    filename: "eciador",
    left: 245, top: 732, width: 795, height: 915, centerX: 642, centerY: 1189,
    desc: "Ecuador är uppkallat efter ekvatorn som löper rakt igenom landet. Trots sin lilla storlek har det enorm biologisk mångfald – från Galapagosöarna (som inspirerade Darwins evolutionsteori) till Andernas toppar."
  },
  {
    name: "Colombia",
    filename: "colombia",
    left: 753, top: 14, width: 771, height: 975, centerX: 1138, centerY: 501,
    desc: "Colombia är det enda sydamerikanska landet med kust mot både Stilla havet och Karibiska havet. Landet är världens tredje största kaffeproducent och känt för sin otroliga biologiska mångfald."
  },
  {
    name: "Venezuela",
    filename: "venezuela",
    left: 1066, top: 5, width: 951, height: 694, centerX: 1541, centerY: 352,
    desc: "Venezuela är hem till Salto Ángel – världens högsta vattenfall på hela 979 meter. Landet har också några av världens största oljereserver. Sjön Maracaibo är Sydamerikas största sjö."
  },
  {
    name: "Guyana",
    filename: "guyana",
    left: 1949, top: 204, width: 708, height: 446, centerX: 2303, centerY: 427,
    desc: "Guyana är det enda engelskspråkiga landet i Sydamerika. Över 80% av landet är täckt av regnskog. Trots att det ligger i Sydamerika har Guyana starka kulturella band till Karibien."
  },
  {
    name: "Surinam",
    filename: "surinam",
    left: 2124, top: 319, width: 360, height: 314, centerX: 2304, centerY: 476,
    desc: "Surinam är Sydamerikas minsta land och det enda där nederländska är officiellt språk – ett arv från kolonialtidens Nederländerna. Landet har en unik kulturell mix av indiska, indonesiska, afrikanska och inhemska traditioner."
  },
  {
    name: "Franska Guyana",
    filename: "franska_guyana",
    left: 2448, top: 372, width: 219, height: 220, centerX: 2557, centerY: 482,
    desc: "Franska Guyana är tekniskt sett inte ett eget land utan ett franskt utomeuropeiskt departement – och därmed en del av EU! Här ligger Europas rymdhamn i Kourou, varifrån Ariane-raketer skjuts upp."
  }
];

const MAP_LEFT = 612, MAP_TOP = 20, MAP_W = 3019, MAP_H = 4297;
const NO_HOVER = new Set(['eciador']); // countries where hover highlight is disabled

const mapPanel = document.querySelector('.map-panel');
const mapWrapper = document.getElementById('map-wrapper');
const baseMap = document.getElementById('base-map');
const infoDefault = document.getElementById('info-default');
const infoCard = document.getElementById('info-card');
const infoName = document.getElementById('info-name');
const infoShape = document.getElementById('info-shape');
const infoDesc = document.getElementById('info-desc');
const exploredCount = document.getElementById('explored-count');
const zoomLevelEl = document.getElementById('zoom-level');

// Track state
const revealed = new Set();
let activeCountry = null;  // currently shown in info panel
const hitCanvases = {};     // offscreen canvases per country for hit detection

// ── Zoom & Pan state ──
let zoom = 1;
let panX = 0, panY = 0;
const MIN_ZOOM = 1, MAX_ZOOM = 5;

// ── Load offscreen canvases for pixel-perfect hit detection ──
function loadHitData() {
  return Promise.all(COUNTRIES.map(c => new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = c.width;
      canvas.height = c.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, c.width, c.height);
      hitCanvases[c.filename] = { canvas, ctx, country: c };
      resolve();
    };
    img.onerror = resolve;
    img.src = `assets/countries/${c.filename}.png`;
  })));
}

// ── Create DOM overlays on the map ──
function createOverlays() {
  COUNTRIES.forEach(c => {
    // Colored overlay (hidden initially)
    const img = document.createElement('img');
    img.className = 'country-overlay';
    img.src = `assets/countries/${c.filename}.png`;
    img.dataset.country = c.filename;
    img.alt = c.name;
    mapWrapper.appendChild(img);

    // Hover highlight overlay
    const hover = document.createElement('img');
    hover.className = 'hover-highlight';
    hover.src = `assets/countries/${c.filename}.png`;
    hover.dataset.country = c.filename;
    mapWrapper.appendChild(hover);
  });
  positionOverlays();
  window.addEventListener('resize', positionOverlays);
}

function positionOverlays() {
  const mapRect = baseMap.getBoundingClientRect();
  const wrapperRect = mapWrapper.getBoundingClientRect();
  const scale = mapRect.width / MAP_W;
  const offsetX = mapRect.left - wrapperRect.left;
  const offsetY = mapRect.top - wrapperRect.top;

  COUNTRIES.forEach(c => {
    const relLeft = (c.left - MAP_LEFT) * scale;
    const relTop = (c.top - MAP_TOP) * scale;
    const relW = c.width * scale;
    const relH = c.height * scale;

    const selectors = [
      `img.country-overlay[data-country="${c.filename}"]`,
      `.hover-highlight[data-country="${c.filename}"]`
    ];
    selectors.forEach(sel => {
      const el = mapWrapper.querySelector(sel);
      if (!el) return;
      el.style.left = (offsetX + relLeft) + 'px';
      el.style.top = (offsetY + relTop) + 'px';
      el.style.width = relW + 'px';
      el.style.height = relH + 'px';
    });
  });
}

// ── Hit test: which country is at this map click? ──
function hitTest(clientX, clientY) {
  const mapRect = baseMap.getBoundingClientRect();
  const scale = MAP_W / mapRect.width;
  const mapX = (clientX - mapRect.left) * scale + MAP_LEFT;
  const mapY = (clientY - mapRect.top) * scale + MAP_TOP;

  // Check countries in reverse order (smallest / top layers first for better UX)
  const sorted = [...COUNTRIES].sort((a, b) => (a.width * a.height) - (b.width * b.height));

  for (const c of sorted) {
    const localX = Math.round(mapX - c.left);
    const localY = Math.round(mapY - c.top);
    if (localX < 0 || localY < 0 || localX >= c.width || localY >= c.height) continue;

    const hc = hitCanvases[c.filename];
    if (!hc) continue;
    const pixel = hc.ctx.getImageData(localX, localY, 1, 1).data;
    if (pixel[3] > 30) return c;  // non-transparent = hit
  }
  return null;
}

// ── Hover ──
let currentHover = null;

function updateHover(e) {
  const hit = hitTest(e.clientX, e.clientY);
  const newHover = hit && !NO_HOVER.has(hit.filename) ? hit.filename : null;

  if (newHover !== currentHover) {
    if (currentHover) {
      mapWrapper.querySelector(`.hover-highlight[data-country="${currentHover}"]`)
        .classList.remove('active');
    }
    if (newHover) {
      mapWrapper.querySelector(`.hover-highlight[data-country="${newHover}"]`)
        .classList.add('active');
    }
    currentHover = newHover;
  }
}

// ── Drag & Click ──
let isDragging = false;
let didDrag = false;
let dragStartX = 0, dragStartY = 0;
let panStartX = 0, panStartY = 0;

function onPointerDown(e) {
  if (e.button !== 0) return;
  // Capture pointer so drag works even if cursor leaves the panel
  mapPanel.setPointerCapture(e.pointerId);
  isDragging = true;
  didDrag = false;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  panStartX = panX;
  panStartY = panY;
  mapWrapper.classList.add('dragging');
}

function onPointerMove(e) {
  if (!isDragging) {
    updateHover(e);
    return;
  }
  const dx = e.clientX - dragStartX;
  const dy = e.clientY - dragStartY;
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didDrag = true;
  if (didDrag) {
    panX = panStartX + dx;
    panY = panStartY + dy;
    clampPan();
    applyTransform();
  }
}

function onPointerUp(e) {
  mapWrapper.classList.remove('dragging');
  if (!isDragging) return;
  isDragging = false;

  // Only toggle a country if it was a clean click (no drag movement)
  if (!didDrag) {
    const hit = hitTest(e.clientX, e.clientY);
    if (hit) toggleCountry(hit);
  }
}

function toggleCountry(c) {
  const overlay = mapWrapper.querySelector(`img.country-overlay[data-country="${c.filename}"]`);

  if (revealed.has(c.filename)) {
    overlay.classList.remove('visible');
    revealed.delete(c.filename);
    if (activeCountry === c.filename) {
      activeCountry = null;
      infoCard.classList.remove('active');
      infoDefault.style.display = '';
    }
  } else {
    overlay.classList.add('visible');
    revealed.add(c.filename);
    activeCountry = c.filename;
    infoName.textContent = c.name;
    infoShape.src = `assets/countries/${c.filename}.png`;
    infoDesc.textContent = c.desc;
    infoDefault.style.display = 'none';
    infoCard.classList.add('active');
  }
  exploredCount.textContent = revealed.size;
}

// ── Zoom & Transform ──
function applyTransform() {
  mapWrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
  zoomLevelEl.textContent = Math.round(zoom * 100) + '%';
}

function clampPan() {
  // Layout size of the map (un-transformed)
  const baseW = baseMap.offsetWidth;
  const baseH = baseMap.offsetHeight;
  // How much bigger the map is than the viewport after zoom
  const overflowX = Math.max(0, baseW * zoom - mapPanel.clientWidth);
  const overflowY = Math.max(0, baseH * zoom - mapPanel.clientHeight);
  const maxX = overflowX / 2;
  const maxY = overflowY / 2;
  panX = Math.max(-maxX, Math.min(maxX, panX));
  panY = Math.max(-maxY, Math.min(maxY, panY));
}

function setZoom(newZoom, cursorX, cursorY) {
  const oldZoom = zoom;
  zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
  if (zoom === oldZoom) return;

  if (cursorX !== undefined && cursorY !== undefined) {
    // Keep the point under cursor stationary
    const panelRect = mapPanel.getBoundingClientRect();
    // Cursor position relative to panel center
    const cx = cursorX - panelRect.left - panelRect.width / 2;
    const cy = cursorY - panelRect.top - panelRect.height / 2;
    // The map-space point under cursor: (cx - panX) / oldZoom
    // After zoom it should still be at cx: newPanX = cx - mapPoint * newZoom
    panX = cx - ((cx - panX) / oldZoom) * zoom;
    panY = cy - ((cy - panY) / oldZoom) * zoom;
  }

  clampPan();
  applyTransform();
}

function onWheel(e) {
  e.preventDefault();
  // Smooth multiplicative zoom – small steps
  const factor = e.deltaY > 0 ? 0.9 : 1.1;
  setZoom(zoom * factor, e.clientX, e.clientY);
}

document.getElementById('zoom-in').addEventListener('click', () => setZoom(zoom * 1.3));
document.getElementById('zoom-out').addEventListener('click', () => setZoom(zoom / 1.3));

// ── Init ──
createOverlays();
loadHitData().then(() => {
  mapPanel.addEventListener('pointerdown', onPointerDown);
  mapPanel.addEventListener('pointermove', onPointerMove);
  mapPanel.addEventListener('pointerup', onPointerUp);
  mapPanel.addEventListener('pointercancel', onPointerUp);
  mapPanel.addEventListener('wheel', onWheel, { passive: false });
});
</script>

</body>
</html>
