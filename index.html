<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forma-spelet</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f1b2d; color: #e7eef7; min-height: 100vh; }
    .hidden { display: none !important; }

    .start-screen { min-height: 100vh; padding: 28px 20px 40px; }
    .start-header { max-width: 1200px; margin: 0 auto 20px; }
    .start-header h1 { color: #6bc8ff; font-size: clamp(1.8rem, 2.8vw, 2.5rem); }
    .start-header p { color: #9fb7ce; margin-top: 6px; }
    .group { max-width: 1200px; margin: 0 auto 22px; }
    .group h2 { color: #8fb6d8; margin-bottom: 10px; font-size: 1rem; text-transform: uppercase; letter-spacing: .08em; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px; }
    .region-card {
      background: linear-gradient(135deg, #1c2d47, #22395b);
      border: 1px solid rgba(111, 179, 230, .25);
      border-radius: 12px; padding: 12px; cursor: pointer; transition: .15s transform, .15s border-color;
      text-align: left;
    }
    .region-card:hover { transform: translateY(-2px); border-color: rgba(111, 179, 230, .55); }
    .thumb { height: 96px; border-radius: 8px; background-size: cover; background-position: center; opacity: .9; }
    .region-name { margin-top: 10px; font-weight: 700; color: #d8ecff; }
    .region-meta { color: #9db7cf; font-size: .9rem; margin-top: 4px; }

    .game-screen { min-height: 100vh; display: flex; flex-direction: column; }
    .topbar {
      background: linear-gradient(135deg, #17263c, #213658);
      padding: 10px 14px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(111, 179, 230, .2);
    }
    .topbar h1 { font-size: 1.1rem; color: #6bc8ff; margin-right: auto; }
    .btn { border: 1px solid rgba(111,179,230,.32); background: #1c304d; color: #d7eaff; border-radius: 8px; padding: 7px 10px; cursor: pointer; }
    .btn:hover { background: #244061; }
    .btn.active { border-color: #6bc8ff; background: #234267; color: #6bc8ff; font-weight: 600; }

    .content { display: grid; grid-template-columns: 1fr 320px; min-height: calc(100vh - 52px); }
    .map-panel { position: relative; display: flex; align-items: center; justify-content: center; padding: 12px; overflow: auto; }
    .map-wrapper { position: relative; max-width: 100%; max-height: calc(100vh - 90px); }
    .map-base, .map-outline { display: block; max-width: 100%; max-height: calc(100vh - 90px); }
    .map-outline { position: absolute; inset: 0; pointer-events: none; }
    .country-overlay { position: absolute; opacity: 0; pointer-events: none; transition: opacity .15s; }
    .country-overlay.visible { opacity: 1; }
    .hit-target { position: absolute; opacity: 0; cursor: pointer; }

    .panel { border-left: 1px solid rgba(111,179,230,.2); background: #13243a; padding: 14px; }
    .panel h3 { color: #6bc8ff; margin-bottom: 8px; }
    .panel p { color: #cce2f7; line-height: 1.45; }
    .muted { color: #93adca; }
    .status { margin: 12px 0; color: #9bc0df; }
    .loading { position: fixed; inset: 0; background: rgba(10,20,35,.82); display: grid; place-items: center; z-index: 50; }
    .loading-box { background: #1a2e49; border: 1px solid rgba(111,179,230,.3); padding: 18px 22px; border-radius: 10px; color: #d6e9ff; }
    ol { padding-left: 20px; margin-top: 8px; }

    @media (max-width: 980px) {
      .content { grid-template-columns: 1fr; }
      .panel { border-left: none; border-top: 1px solid rgba(111,179,230,.2); }
      .map-base, .map-outline, .map-wrapper { max-height: 58vh; }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading hidden"><div class="loading-box" id="loading-text">Laddar…</div></div>

  <section class="start-screen" id="start-screen">
    <div class="start-header">
      <h1>Forma-spelet</h1>
      <p>Välj en region och spela i Utforska- eller Quiz-läge.</p>
    </div>
    <div class="group">
      <h2>Världsdelar</h2>
      <div class="cards" id="continents"></div>
    </div>
    <div class="group">
      <h2>Övriga</h2>
      <div class="cards" id="others"></div>
    </div>
  </section>

  <section class="game-screen hidden" id="game-screen">
    <header class="topbar">
      <button class="btn" id="back-btn">← Tillbaka</button>
      <h1 id="title">Forma-spelet</h1>
      <button class="btn active" id="explore-btn">Utforska</button>
      <button class="btn" id="quiz-btn">Quiz</button>
    </header>
    <div class="content">
      <div class="map-panel">
        <div class="map-wrapper" id="map-wrapper"></div>
      </div>
      <aside class="panel">
        <h3 id="panel-title">Välj region</h3>
        <p id="panel-body" class="muted">Klicka på en region för att börja.</p>
        <div class="status" id="status"></div>
        <h3>Topplista (region)</h3>
        <ol id="highscores"></ol>
      </aside>
    </div>
  </section>

  <script>
    const REGION_META = [
      { id: 'sydamerika', name: 'Sydamerika', group: 'continents' },
      { id: 'nordamerika', name: 'Nordamerika', group: 'continents' },
      { id: 'europa', name: 'Europa', group: 'continents' },
      { id: 'asien', name: 'Asien', group: 'continents' },
      { id: 'afrika', name: 'Afrika', group: 'continents' },
      { id: 'oceanien', name: 'Oceanien', group: 'continents' },
      { id: 'vastindien', name: 'Västindien', group: 'others' },
      { id: 'usa', name: 'USA (delstater)', group: 'others' },
      { id: 'sverige', name: 'Sverige (landskap)', group: 'others' }
    ];

    const NAME_FIXES = { VItryssland: 'Vitryssland', Eciador: 'Ecuador', Indoneien: 'Indonesien' };
    const EXCLUDED = new Set(['Vättern', 'Vänern']);

    const SOUTH_AMERICA_FACTS = {
      Argentina: { desc: 'Långsträckt land från subtropiskt klimat till kalla Patagonien.' },
      Brasilien: { desc: 'Störst i Sydamerika och hem till Amazonas.' },
      Chile: { desc: 'Världens längsta smala land längs Anderna.' },
      Bolivia: { desc: 'Höghöjdsland med Altiplano och Titicacasjön.' },
      Peru: { desc: 'Machu Picchu och lång kust mot Stilla havet.' }
    };

    let mode = 'explore';
    let currentRegion = null;
    let quizQueue = [];
    let quizStart = 0;
    let guessed = new Set();

    const el = id => document.getElementById(id);
    const loading = (on, text='Laddar…') => { el('loading').classList.toggle('hidden', !on); el('loading-text').textContent = text; };

    function normalizeName(name) { return NAME_FIXES[name] || name; }

    async function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function buildCards() {
      for (const region of REGION_META) {
        fetch(`assets/${region.id}/config.json`).then(r => r.json()).then(cfg => {
          const countries = cfg.countries.filter(c => !c.name.endsWith('!') && !EXCLUDED.has(c.name) && !/shape$/i.test(c.name));
          const btn = document.createElement('button');
          btn.className = 'region-card';
          btn.innerHTML = `<div class="thumb" style="background-image:url('assets/${region.id}/map.webp')"></div>
            <div class="region-name">${region.name}</div>
            <div class="region-meta">${countries.length} områden</div>`;
          btn.addEventListener('click', () => openRegion(region));
          el(region.group).appendChild(btn);
        });
      }
    }

    function parseCountries(cfg) {
      const shapes = new Map();
      for (const c of cfg.countries) {
        if (/shape$/i.test(c.name) || /_shape\./i.test(c.file)) {
          const key = normalizeName(c.name.replace(/\s*shape$/i, '').replace(/_shape$/i, ''));
          shapes.set(key, c);
        }
      }

      const main = [];
      for (const c of cfg.countries) {
        if (c.name.endsWith('!')) continue;
        if (/shape$/i.test(c.name) || /_shape\./i.test(c.file)) continue;
        const fixed = normalizeName(c.name);
        if (EXCLUDED.has(fixed)) continue;
        main.push({
          key: fixed,
          displayName: fixed,
          display: c,
          hit: shapes.get(fixed) || c
        });
      }
      return main;
    }

    function setMode(nextMode) {
      mode = nextMode;
      el('explore-btn').classList.toggle('active', mode === 'explore');
      el('quiz-btn').classList.toggle('active', mode === 'quiz');
      if (!currentRegion) return;
      if (mode === 'quiz') startQuiz();
      else {
        guessed.clear();
        updateOverlays();
        el('panel-title').textContent = 'Utforska';
        el('panel-body').textContent = 'Hovra eller klicka på ett område för namn/info.';
        el('status').textContent = `${currentRegion.countries.length} områden tillgängliga.`;
      }
    }

    function updateOverlays(hoverKey = null) {
      for (const c of currentRegion.countries) {
        const show = mode === 'explore' ? c.key === hoverKey : guessed.has(c.key);
        c.overlayEl.classList.toggle('visible', show);
      }
    }

    function renderHighscores() {
      const key = `${currentRegion.id}-highscores`;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      el('highscores').innerHTML = list.length
        ? list.map(s => `<li>${s.name} — ${s.time.toFixed(1)} s</li>`).join('')
        : '<li class="muted">Inga resultat ännu.</li>';
    }

    function saveScore(seconds) {
      const name = prompt('Namn till topplistan:', 'Spelare') || 'Spelare';
      const key = `${currentRegion.id}-highscores`;
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push({ name: name.slice(0, 20), time: seconds });
      list.sort((a,b) => a.time - b.time);
      localStorage.setItem(key, JSON.stringify(list.slice(0, 10)));
      renderHighscores();
    }

    function startQuiz() {
      guessed.clear();
      quizQueue = [...currentRegion.countries].sort(() => Math.random() - 0.5);
      quizStart = performance.now();
      updateOverlays();
      askNext();
    }

    function askNext() {
      if (!quizQueue.length) {
        const seconds = (performance.now() - quizStart) / 1000;
        el('panel-title').textContent = 'Klart!';
        el('panel-body').textContent = `Snyggt! Tid: ${seconds.toFixed(1)} sekunder.`;
        el('status').textContent = `Alla ${currentRegion.countries.length} rätt.`;
        saveScore(seconds);
        return;
      }
      const target = quizQueue[0];
      el('panel-title').textContent = 'Hitta området';
      el('panel-body').textContent = target.displayName;
      el('status').textContent = `${guessed.size}/${currentRegion.countries.length} rätt`;
    }

    function onCountryClick(country) {
      if (mode === 'explore') {
        const fact = currentRegion.id === 'sydamerika' ? SOUTH_AMERICA_FACTS[country.displayName]?.desc : null;
        el('panel-title').textContent = country.displayName;
        el('panel-body').textContent = fact || 'Ingen extra beskrivning för denna region ännu.';
        updateOverlays(country.key);
        return;
      }
      const target = quizQueue[0];
      if (!target) return;
      if (country.key === target.key) {
        guessed.add(country.key);
        quizQueue.shift();
        updateOverlays();
        askNext();
      } else {
        el('status').textContent = `Fel: ${country.displayName}. Försök igen med ${target.displayName}.`;
      }
    }

    async function openRegion(region) {
      loading(true, `Laddar ${region.name}…`);
      try {
        const cfg = await fetch(`assets/${region.id}/config.json`).then(r => r.json());
        const countries = parseCountries(cfg);
        const mapUrl = `assets/${region.id}/map.webp`;
        const outlineUrl = `assets/${region.id}/overlay.webp`;
        const mapImg = await loadImage(mapUrl);
        await Promise.all(countries.map(c => loadImage(`assets/${region.id}/${c.display.file}`)));

        currentRegion = { id: region.id, name: region.name, cfg, countries };
        el('title').textContent = `Forma-spelet — ${region.name}`;
        el('start-screen').classList.add('hidden');
        el('game-screen').classList.remove('hidden');

        const wrap = el('map-wrapper');
        wrap.innerHTML = '';
        const base = document.createElement('img');
        base.src = mapUrl;
        base.className = 'map-base';
        wrap.appendChild(base);

        for (const c of countries) {
          const overlay = document.createElement('img');
          overlay.src = `assets/${region.id}/${c.display.file}`;
          overlay.className = 'country-overlay';
          overlay.style.left = `${(c.display.left / cfg.mapWidth) * 100}%`;
          overlay.style.top = `${(c.display.top / cfg.mapHeight) * 100}%`;
          overlay.style.width = `${(c.display.width / cfg.mapWidth) * 100}%`;
          overlay.style.height = `${(c.display.height / cfg.mapHeight) * 100}%`;

          const hit = document.createElement('img');
          hit.src = `assets/${region.id}/${c.hit.file}`;
          hit.className = 'hit-target';
          hit.style.left = `${(c.hit.left / cfg.mapWidth) * 100}%`;
          hit.style.top = `${(c.hit.top / cfg.mapHeight) * 100}%`;
          hit.style.width = `${(c.hit.width / cfg.mapWidth) * 100}%`;
          hit.style.height = `${(c.hit.height / cfg.mapHeight) * 100}%`;
          hit.addEventListener('mouseenter', () => mode === 'explore' && updateOverlays(c.key));
          hit.addEventListener('mouseleave', () => mode === 'explore' && updateOverlays());
          hit.addEventListener('click', () => onCountryClick(c));

          wrap.appendChild(overlay);
          wrap.appendChild(hit);
          c.overlayEl = overlay;
        }

        if (region.id !== 'vastindien') {
          const outline = document.createElement('img');
          outline.src = outlineUrl;
          outline.className = 'map-outline';
          outline.onerror = () => outline.remove();
          wrap.appendChild(outline);
        }

        renderHighscores();
        setMode(mode);
      } finally {
        loading(false);
      }
    }

    el('explore-btn').addEventListener('click', () => setMode('explore'));
    el('quiz-btn').addEventListener('click', () => setMode('quiz'));
    el('back-btn').addEventListener('click', () => {
      currentRegion = null;
      el('game-screen').classList.add('hidden');
      el('start-screen').classList.remove('hidden');
    });

    buildCards();
  </script>
</body>
</html>
