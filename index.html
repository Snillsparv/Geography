<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geografi ‚Äì Forma-spelet</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f1b2d;
      color: #e0e0e0;
      min-height: 100vh;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Start screen ‚îÄ‚îÄ */
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
    }

    #start-screen h1 {
      font-size: 2.4rem;
      color: #5bbfff;
      margin-bottom: 8px;
    }

    #start-screen .subtitle {
      color: #6a8eab;
      font-size: 1rem;
      margin-bottom: 36px;
    }

    .region-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 720px;
      width: 100%;
    }

    .region-card {
      background: linear-gradient(135deg, #1a2940, #243654);
      border: 1px solid rgba(91,191,255,0.15);
      border-radius: 14px;
      padding: 24px 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .region-card:hover {
      border-color: rgba(91,191,255,0.5);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .region-card .region-icon {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    .region-card .region-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #5bbfff;
      margin-bottom: 4px;
    }

    .region-card .region-count {
      font-size: 0.8rem;
      color: #5a8aaa;
    }

    @media (max-width: 600px) {
      .region-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ‚îÄ‚îÄ Game screen (hidden until region selected) ‚îÄ‚îÄ */
    #game-screen { display: none; }

    header {
      background: linear-gradient(135deg, #1a2940, #2a4060);
      padding: 10px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      gap: 16px;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #5bbfff;
      white-space: nowrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .back-btn {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(91,191,255,0.2);
      color: #5bbfff;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .back-btn:hover {
      background: rgba(91,191,255,0.1);
      border-color: rgba(91,191,255,0.4);
    }

    .mode-toggle {
      display: flex;
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .mode-btn {
      padding: 8px 18px;
      border: none;
      background: transparent;
      color: #6a8eab;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .mode-btn.active {
      background: rgba(91,191,255,0.15);
      color: #5bbfff;
      font-weight: 600;
    }

    .mode-btn:hover:not(.active) {
      background: rgba(255,255,255,0.05);
    }

    .header-hint {
      color: #6a8eab;
      font-size: 0.85rem;
      text-align: right;
      min-width: 0;
    }

    .game-container {
      display: flex;
      height: calc(100vh - 52px);
    }

    /* ‚îÄ‚îÄ Map panel ‚îÄ‚îÄ */
    .map-panel {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .map-wrapper {
      position: relative;
      max-height: 100%;
      cursor: default;
      transform-origin: center center;
      transition: transform 0.18s ease-out;
    }

    .map-wrapper.dragging {
      cursor: default;
      transition: none !important;
    }

    .map-wrapper img.base-map {
      max-height: calc(100vh - 92px);
      width: auto;
      display: block;
      transition: filter 0.4s;
    }

    /* Zoom controls */
    .zoom-controls {
      position: absolute;
      bottom: 24px;
      left: 24px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }

    .zoom-btn {
      width: 38px;
      height: 38px;
      background: rgba(22, 34, 53, 0.9);
      border: 1px solid rgba(91,191,255,0.2);
      border-radius: 8px;
      color: #5bbfff;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      user-select: none;
    }

    .zoom-btn:hover {
      background: rgba(42, 64, 96, 0.95);
      border-color: rgba(91,191,255,0.5);
    }

    .zoom-level {
      text-align: center;
      font-size: 0.7rem;
      color: #4a6a82;
      padding: 2px 0;
      user-select: none;
    }

    .country-overlay {
      position: absolute;
      transition: opacity 0.4s ease;
      opacity: 0;
      pointer-events: none;
      will-change: opacity, filter;
    }

    .country-overlay.visible { opacity: 1; }

    .country-overlay.hovered {
      filter: brightness(0.78) saturate(0.9);
      transition: filter 0.15s, opacity 0.4s ease;
    }

    .country-overlay.flash-wrong {
      opacity: 0.45;
      transition: opacity 0.15s;
    }

    .country-overlay.hint-blink {
      animation: hintBlink 0.5s ease-in-out 3;
    }

    @keyframes hintBlink {
      0%, 100% { opacity: 0; }
      50% { opacity: 0.6; }
    }

    .hover-highlight {
      position: absolute;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      will-change: opacity;
    }

    .hover-highlight.active { opacity: 1; }

    .map-overlay {
      position: absolute;
      pointer-events: none;
      z-index: 5;
    }

    /* ‚îÄ‚îÄ Cursor label ‚îÄ‚îÄ */
    .cursor-label {
      position: fixed;
      pointer-events: none;
      z-index: 100;
      background: rgba(16, 28, 48, 0.92);
      color: #5bbfff;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 8px;
      border: 1px solid rgba(91,191,255,0.3);
      white-space: nowrap;
      display: none;
      transform: translate(14px, 14px);
    }

    .cursor-label.explore-tooltip {
      white-space: pre-line;
      max-width: 260px;
      text-align: left;
    }

    /* ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ */
    .info-panel {
      width: 380px;
      background: linear-gradient(180deg, #162235, #1a2a42);
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 20px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .info-panel-content {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .info-header {
      padding: 16px 24px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .info-header h2 {
      font-size: 1rem;
      color: #5a8aaa;
      font-weight: 500;
    }

    .info-default {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      text-align: center;
      color: #4a6a82;
    }

    .info-default .arrow-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.4; }
    .info-default p { font-size: 1rem; line-height: 1.6; }

    .info-card {
      display: none;
      flex-direction: column;
      padding: 24px;
      gap: 16px;
      animation: slideIn 0.3s ease;
    }

    .info-card.active { display: flex; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .info-card .country-name { font-size: 1.6rem; font-weight: 700; color: #5bbfff; }

    .info-card .country-shape-preview {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(91,191,255,0.1);
      border-radius: 12px;
    }

    .info-card .country-shape-preview img { max-width: 90%; max-height: 160px; object-fit: contain; }

    .info-card .description { font-size: 0.95rem; line-height: 1.7; color: #b0c8d8; }

    .assoc-box {
      background: rgba(100, 180, 255, 0.12);
      border: 1px solid rgba(100, 180, 255, 0.3);
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 12px;
      font-weight: 700;
      color: #7ec8e3;
    }

    .info-card .close-hint { margin-top: 8px; font-size: 0.8rem; color: #4a6a82; text-align: center; }

    .counter {
      padding: 16px 24px;
      border-top: 1px solid rgba(255,255,255,0.06);
      color: #5a8aaa;
      font-size: 0.85rem;
      text-align: center;
      margin-top: auto;
    }

    .counter strong { color: #5bbfff; }

    /* ‚îÄ‚îÄ Seterra panel ‚îÄ‚îÄ */
    .seterra-panel {
      display: none;
      flex-direction: column;
      padding: 24px;
      gap: 20px;
    }

    .seterra-panel.active { display: flex; }

    .seterra-target { text-align: center; }
    .seterra-target .label { font-size: 0.85rem; color: #5a8aaa; margin-bottom: 6px; }
    .seterra-target .target-name { font-size: 1.8rem; font-weight: 700; color: #5bbfff; }

    .seterra-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .stat-box {
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .stat-box .stat-label {
      font-size: 0.75rem;
      color: #5a8aaa;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-box .stat-value { font-size: 1.4rem; font-weight: 700; color: #cde; }
    .stat-box .stat-value.correct { color: #4cdf8b; }
    .stat-box .stat-value.wrong { color: #ff6b6b; }
    .stat-box .stat-value.score { color: #5bbfff; }
    .stat-box .stat-value.time { color: #e8c547; }

    .seterra-feedback {
      min-height: 80px;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
      transition: all 0.3s;
    }

    .seterra-feedback.correct-fb {
      background: rgba(76,223,139,0.1);
      border: 1px solid rgba(76,223,139,0.2);
    }

    .seterra-feedback.wrong-fb {
      background: rgba(255,107,107,0.1);
      border: 1px solid rgba(255,107,107,0.2);
    }

    .seterra-feedback .fb-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .seterra-feedback.correct-fb .fb-title { color: #4cdf8b; }
    .seterra-feedback.wrong-fb .fb-title { color: #ff6b6b; }
    .seterra-feedback .fb-desc { font-size: 0.85rem; color: #8ab0c8; line-height: 1.5; }

    .seterra-progress { background: rgba(255,255,255,0.06); border-radius: 6px; height: 8px; overflow: hidden; }

    .seterra-progress .bar {
      height: 100%;
      background: linear-gradient(90deg, #2980b9, #5bbfff);
      transition: width 0.4s ease;
      border-radius: 6px;
    }

    .seterra-progress-label { font-size: 0.8rem; color: #5a8aaa; text-align: center; margin-top: 4px; }

    .seterra-done {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 24px;
      text-align: center;
    }

    .seterra-done.active { display: flex; }
    .seterra-done h2 { font-size: 1.5rem; color: #5bbfff; }
    .seterra-done .big-score { font-size: 3rem; font-weight: 700; color: #4cdf8b; }
    .seterra-done .done-detail { color: #88b4d8; font-size: 0.95rem; line-height: 1.6; }

    .restart-btn {
      padding: 12px 36px;
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .retry-btn { background: linear-gradient(135deg, #d4820a, #e8a030); }
    .retry-btn:hover { transform: scale(1.05); box-shadow: 0 4px 16px rgba(232,160,48,0.3); }
    .restart-btn:hover { transform: scale(1.05); box-shadow: 0 4px 16px rgba(46,204,113,0.3); }

    /* ‚îÄ‚îÄ Jonas high-five ‚îÄ‚îÄ */
    .jonas-section {
      padding: 12px 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .jonas-section img {
      width: 100px;
      height: auto;
      cursor: pointer;
      border-radius: 10px;
      transition: transform 0.15s;
      user-select: none;
    }

    .jonas-section img:hover { transform: scale(1.08); }
    .jonas-section img:active { transform: scale(0.95); }
    .highfive-counter { font-size: 0.8rem; color: #5a8aaa; }
    .highfive-counter strong { color: #5bbfff; }

    /* ‚îÄ‚îÄ Name popup modal ‚îÄ‚îÄ */
    .name-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.65);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .name-modal-overlay.active { display: flex; }

    .name-modal {
      background: linear-gradient(135deg, #1a2940, #243654);
      border: 1px solid rgba(91,191,255,0.3);
      border-radius: 16px;
      padding: 32px 36px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      box-shadow: 0 12px 48px rgba(0,0,0,0.5);
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9) translateY(20px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .name-modal h3 { font-size: 1.3rem; color: #5bbfff; margin-bottom: 6px; }
    .name-modal .modal-score { font-size: 2.2rem; font-weight: 700; color: #4cdf8b; margin-bottom: 12px; }
    .name-modal .modal-detail { font-size: 0.9rem; color: #88b4d8; margin-bottom: 20px; line-height: 1.5; }

    .name-modal .modal-input-row { display: flex; gap: 8px; margin-bottom: 12px; }

    .name-modal .modal-input-row input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(91,191,255,0.3);
      background: rgba(0,0,0,0.3);
      color: #e0e0e0;
      font-size: 1rem;
      outline: none;
    }

    .name-modal .modal-input-row input:focus {
      border-color: rgba(91,191,255,0.7);
      box-shadow: 0 0 12px rgba(91,191,255,0.15);
    }

    .name-modal .modal-input-row button {
      padding: 12px 22px;
      background: linear-gradient(135deg, #2980b9, #5bbfff);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.15s;
    }

    .name-modal .modal-input-row button:hover { transform: scale(1.05); }

    .name-modal .modal-skip {
      background: none;
      border: none;
      color: #4a6a82;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 6px 12px;
    }

    .name-modal .modal-skip:hover { color: #6a8eab; }

    .hs-form { display: flex; gap: 8px; align-items: center; width: 100%; max-width: 300px; }

    .hs-form input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid rgba(91,191,255,0.3);
      background: rgba(0,0,0,0.3);
      color: #e0e0e0;
      font-size: 0.95rem;
      outline: none;
    }

    .hs-form input:focus { border-color: rgba(91,191,255,0.6); }

    .hs-form button {
      padding: 10px 18px;
      background: linear-gradient(135deg, #2980b9, #5bbfff);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .hs-saved-msg { color: #4cdf8b; font-size: 0.85rem; display: none; }

    .highscore-list { width: 100%; max-width: 320px; }
    .highscore-list h3 { font-size: 1rem; color: #5a8aaa; margin-bottom: 8px; }
    .hs-table { width: 100%; border-collapse: collapse; }
    .hs-table th { font-size: 0.7rem; color: #4a6a82; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .hs-table th:last-child, .hs-table td:last-child { text-align: right; }
    .hs-table td { padding: 6px; font-size: 0.9rem; color: #b0c8d8; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .hs-table tr.hs-current td { color: #5bbfff; font-weight: 600; }
    .hs-empty { color: #4a6a82; font-size: 0.85rem; font-style: italic; }

    /* ‚îÄ‚îÄ Loading indicator ‚îÄ‚îÄ */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 27, 45, 0.95);
      z-index: 300;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: #5bbfff;
      font-size: 1.2rem;
    }

    .loading-overlay.hidden { display: none; }

    .loading-spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(91,191,255,0.2);
      border-top-color: #5bbfff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      body { overflow: auto; }
      .game-container { flex-direction: column; height: auto; }
      .map-panel { height: 50vh; min-height: 300px; }
      .map-wrapper img.base-map { max-height: 46vh; }
      .info-panel { width: 100%; min-height: 50vh; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê START SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="start-screen">
  <h1>Geografi-spelet</h1>
  <p class="subtitle">V&auml;lj en region att &ouml;va p&aring;</p>
  <div class="region-grid" id="region-grid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen">
  <header>
    <div class="header-left">
      <button class="back-btn" id="back-btn">&larr; Tillbaka</button>
      <h1 id="game-title">---</h1>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" data-mode="explore">Utforska</button>
      <button class="mode-btn" data-mode="seterra">Klassiskt Quiz</button>
    </div>
    <span class="header-hint" id="header-hint">Klicka p&aring; ett land</span>
  </header>

  <div class="game-container">
    <div class="map-panel">
      <div class="map-wrapper" id="map-wrapper">
        <img class="base-map" id="base-map" src="" alt="Karta" draggable="false">
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in" title="Zooma in">+</button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="zoom-btn" id="zoom-out" title="Zooma ut">&minus;</button>
      </div>
    </div>

    <div class="info-panel" id="info-panel">
      <div class="info-panel-content">
        <div id="explore-ui">
          <div class="info-header"><h2>Information</h2></div>
          <div class="info-default" id="info-default">
            <div class="arrow-icon">&larr;</div>
            <p>Klicka p&aring; ett land p&aring; kartan<br>f&ouml;r att se dess form!</p>
          </div>
          <div class="info-card" id="info-card">
            <div class="country-name" id="info-name"></div>
            <div class="country-shape-preview">
              <img id="info-shape" src="" alt="">
            </div>
            <div class="description" id="info-desc"></div>
            <div class="close-hint">Klicka p&aring; landet igen f&ouml;r att d&ouml;lja</div>
          </div>
          <div class="counter">
            Utforskade: <strong id="explored-count">0</strong> / <strong id="total-count">0</strong>
          </div>
        </div>

        <div id="seterra-ui" style="display:none;">
          <div class="info-header"><h2>Klassiskt Quiz</h2></div>
          <div class="seterra-panel active" id="seterra-game">
            <div class="seterra-target">
              <div class="label" id="seterra-label">Hitta detta land:</div>
              <div class="target-name" id="seterra-target-name">---</div>
            </div>
            <div class="seterra-stats">
              <div class="stat-box">
                <div class="stat-label">Po&auml;ng</div>
                <div class="stat-value score" id="seterra-score">100%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Tid</div>
                <div class="stat-value time" id="seterra-time">0:00</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">R&auml;tt</div>
                <div class="stat-value correct" id="seterra-correct">0</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Fel</div>
                <div class="stat-value wrong" id="seterra-wrong">0</div>
              </div>
            </div>
            <div class="seterra-progress">
              <div class="bar" id="seterra-bar" style="width:0%"></div>
            </div>
            <div class="seterra-progress-label" id="seterra-progress-label">0 / 0</div>
            <div class="seterra-feedback" id="seterra-feedback"></div>
          </div>

          <div class="seterra-done" id="seterra-done">
            <h2>Klart!</h2>
            <div class="big-score" id="seterra-final-score"></div>
            <div class="done-detail" id="seterra-final-detail"></div>
            <div class="hs-form" id="hs-form">
              <input type="text" id="hs-name" placeholder="Ditt namn" maxlength="20">
              <button id="hs-save">Spara</button>
            </div>
            <div class="hs-saved-msg" id="hs-saved-msg">Sparat!</div>
            <div class="highscore-list" id="highscore-list"></div>
            <button class="restart-btn retry-btn" id="seterra-retry" style="display:none">&Ouml;va p&aring; felaktiga</button>
            <button class="restart-btn" id="seterra-restart">Spela igen</button>
          </div>
        </div>
      </div>

      <div class="jonas-section">
        <img id="jonas-img" src="Jonas_1.webp" alt="Jonas" draggable="false">
        <div class="highfive-counter">High fives: <strong id="highfive-count">0</strong></div>
      </div>
    </div>
  </div>
</div>

<div class="cursor-label" id="cursor-label"></div>

<div class="name-modal-overlay" id="name-modal-overlay">
  <div class="name-modal">
    <h3>Snyggt spelat!</h3>
    <div class="modal-score" id="modal-score"></div>
    <div class="modal-detail" id="modal-detail"></div>
    <div class="modal-input-row">
      <input type="text" id="modal-name" placeholder="Skriv ditt namn..." maxlength="20">
      <button id="modal-save">Spara</button>
    </div>
    <button class="modal-skip" id="modal-skip">Hoppa &ouml;ver</button>
  </div>
</div>

<div class="loading-overlay hidden" id="loading-overlay">
  <div class="loading-spinner"></div>
  <div>Laddar kartan...</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REGION DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REGIONS = [
  { id: 'sydamerika',   name: 'Sydamerika',   icon: 'üåé', itemLabel: 'l√§nder' },
  { id: 'nordamerika',  name: 'Nordamerika',  icon: 'üåé', itemLabel: 'l√§nder' },
  { id: 'europa',       name: 'Europa',       icon: 'üåç', itemLabel: 'l√§nder' },
  { id: 'asien',        name: 'Asien',        icon: 'üåè', itemLabel: 'l√§nder' },
  { id: 'afrika',       name: 'Afrika',       icon: 'üåç', itemLabel: 'l√§nder' },
  { id: 'oceanien',     name: 'Oceanien',     icon: 'üåè', itemLabel: 'l√§nder' },
  { id: 'usa',          name: 'USA',          icon: 'üá∫üá∏', itemLabel: 'delstater' },
  { id: 'sverige',      name: 'Sverige',      icon: 'üá∏üá™', itemLabel: 'landskap' },
  { id: 'vastindien',   name: 'V√§stindien',   icon: 'üèùÔ∏è', itemLabel: 'l√§nder' },
];

// Associations (mnemonics) ‚Äì only for Sydamerika currently
const IMAGE_ASSOCIATIONS = {
  sydamerika: {
    peru: 'En kl√§ttrare som heter PER',
    eciador: 'En vattenslang som sprutar vatten l√§ngs hela EKVATORN',
    colombia: 'En COOL ko med solglas√∂gon',
    venezuela: 'En V√ÑN som kommer springande och h√§lsar',
    guyana: 'Ett kors, de som bor d√§r s√§ger "GUD? G√ÑRNA!"',
    surinam: 'En SUR liten filur som smaskar: "NAM NAM NAM"',
    franska_guyana: 'En FRANSK snigel som h√§nger ihop med GUYANA till v√§nster',
    brasilien: 'Huvudet p√• ett lejon som tatuerat in ett fotbollsm√∂nster f√∂r att st√∂tta BRASILIENS landslag',
    bolivia: 'En urna som det v√§xer en BOLL i ist√§llet f√∂r en v√§xt',
    paraguay: 'Ett foster som vill ha PARA',
    uruguay: 'Ett UR',
    argentina: 'En ARG kille som har f√•tt en kycklingklubba i √∂gat',
    chile: 'En CHILI-peppar',
  }
};

// Descriptions ‚Äì only for Sydamerika currently
const DESCRIPTIONS = {
  sydamerika: {
    argentina: 'Argentina √§r Sydamerikas n√§st st√∂rsta land och str√§cker sig fr√•n subtropiska norra regioner ner till det iskalla Patagonien. Landet √§r k√§nt f√∂r tango, biff, och fotbollslegenden Maradona.',
    chile: 'Chile √§r v√§rldens smalaste land och str√§cker sig √∂ver 4 300 km l√§ngs Sydamerikas v√§stkust. Fr√•n Atacama√∂knen i norr till glaci√§rer i s√∂der.',
    uruguay: 'Uruguay √§r ett av Sydamerikas minsta l√§nder men rankas ofta h√∂gst i demokrati och levnadsstandard. Vann f√∂rsta fotbolls-VM 1930.',
    paraguay: 'Paraguay √§r ett av bara tv√• landl√•sta l√§nder i Sydamerika. Floden Paraguay delar landet i tv√• helt olika halvor.',
    brasilien: 'Brasilien √§r Sydamerikas gigant och t√§cker n√§stan halva kontinenten. Landet rymmer Amazonas regnskog och √§r v√§rldens femte st√∂rsta land.',
    bolivia: 'Bolivia √§r Sydamerikas andra landl√•sta land och hem till Salar de Uyuni ‚Äì v√§rldens st√∂rsta salt√∂ken. La Paz ligger p√• √∂ver 3 600 meters h√∂jd.',
    peru: 'Peru var hj√§rtat av Inkariket och hem till Machu Picchu. Landet har tre zoner: kusten, Anderna och Amazonas regnskog.',
    eciador: 'Ecuador √§r uppkallat efter ekvatorn. Trots sin lilla storlek har det enorm biologisk m√•ngfald ‚Äì fr√•n Gal√°pagos√∂arna till Andernas toppar.',
    colombia: 'Colombia √§r det enda sydamerikanska landet med kust mot b√•de Stilla havet och Karibiska havet. V√§rldens tredje st√∂rsta kaffeproducent.',
    venezuela: 'Venezuela √§r hem till Salto √Ångel ‚Äì v√§rldens h√∂gsta vattenfall p√• 979 meter. Landet har n√•gra av v√§rldens st√∂rsta oljereserver.',
    guyana: 'Guyana √§r det enda engelskspr√•kiga landet i Sydamerika. √ñver 80% av landet √§r t√§ckt av regnskog.',
    surinam: 'Surinam √§r Sydamerikas minsta land och det enda d√§r nederl√§ndska √§r officiellt spr√•k. En unik kulturell mix.',
    franska_guyana: 'Franska Guyana √§r ett franskt utomeuropeiskt departement ‚Äì och d√§rmed en del av EU! H√§r ligger Europas rymdhamn i Kourou.',
  }
};

// Special rules per region
// "shape" entries: extra images used only for hit detection (not quizzed)
// "exclude" entries: names that should not be quizzable (lakes, shapes, etc.)
// "!" entries: in vastindien, entries ending with "!" are zoomed-in duplicates
const REGION_RULES = {
  sydamerika: {
    shapes: { 'Bolivia': { shapeName: 'Bolivia Shape' } },
    exclude: ['Bolivia Shape'],
  },
  sverige: {
    exclude: ['V√§ttern', 'V√§nern'],
  },
  vastindien: {
    // entries with "!" are zoom-in views; their non-"!" counterparts are the actual clickable ones
    // We keep both for display but only quiz the non-"!" versions
    bangDuplicates: true,
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRegionId = null;
let config = null;         // loaded config.json
let COUNTRIES = [];        // processed country list (quizzable)
let ALL_ENTRIES = [];      // all entries from config (including shapes/lakes)
let mapLeft = 0, mapTop = 0, mapW = 0, mapH = 0;

const hitCanvases = {};
const hitPixelData = {};
const overlayEls = {};
const hoverEls = {};
const revealed = new Set();
const justRevealed = new Set();
let sortedCountries = [];
let currentMode = 'explore';
let currentHover = null;
let hoverRafPending = false;

// Zoom & Pan
let zoom = 1, panX = 0, panY = 0;
const MIN_ZOOM = 1, MAX_ZOOM = 5;

// Explore state
let activeCountry = null;
let exploreTooltipTimer = null;

// Seterra state
let seterraQueue = [];
let seterraTarget = null;
let seterraCorrect = 0;
let seterraWrong = 0;
let seterraTotal = 0;
let seterraStartTime = 0;
let seterraTimerInterval = null;
let seterraLocked = false;
let seterraTargetMisses = 0;
let seterraElapsed = 0;
let seterraMissedCountries = new Set();
let seterraIsRetry = false;

// Bolivia shape data (for sydamerika)
let boliviaShapeEntry = null;
let boliviaShapeHitData = null;

// DOM elements
const mapPanel = document.querySelector('.map-panel');
const mapWrapper = document.getElementById('map-wrapper');
const baseMap = document.getElementById('base-map');
const zoomLevelEl = document.getElementById('zoom-level');
const cursorLabel = document.getElementById('cursor-label');
const headerHint = document.getElementById('header-hint');
const infoDefault = document.getElementById('info-default');
const infoCard = document.getElementById('info-card');
const infoName = document.getElementById('info-name');
const infoShape = document.getElementById('info-shape');
const infoDesc = document.getElementById('info-desc');
const exploredCountEl = document.getElementById('explored-count');
const totalCountEl = document.getElementById('total-count');
const seterraTargetName = document.getElementById('seterra-target-name');
const seterraScoreEl = document.getElementById('seterra-score');
const seterraTimeEl = document.getElementById('seterra-time');
const seterraCorrectEl = document.getElementById('seterra-correct');
const seterraWrongEl = document.getElementById('seterra-wrong');
const seterraBar = document.getElementById('seterra-bar');
const seterraProgressLabel = document.getElementById('seterra-progress-label');
const seterraFeedback = document.getElementById('seterra-feedback');
const seterraDone = document.getElementById('seterra-done');
const seterraGame = document.getElementById('seterra-game');
const nameModalOverlay = document.getElementById('name-modal-overlay');
const modalNameInput = document.getElementById('modal-name');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildStartScreen() {
  const grid = document.getElementById('region-grid');
  grid.innerHTML = '';
  REGIONS.forEach(r => {
    const card = document.createElement('div');
    card.className = 'region-card';
    card.innerHTML = `<div class="region-icon">${r.icon}</div><div class="region-name">${r.name}</div><div class="region-count">${r.itemLabel}</div>`;
    card.addEventListener('click', () => loadRegion(r.id));
    grid.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD A REGION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadRegion(regionId) {
  const loading = document.getElementById('loading-overlay');
  loading.classList.remove('hidden');

  try {
    const resp = await fetch(`assets/${regionId}/config.json`);
    config = await resp.json();
  } catch (e) {
    alert('Kunde inte ladda regionen: ' + regionId);
    loading.classList.add('hidden');
    return;
  }

  currentRegionId = regionId;
  const rules = REGION_RULES[regionId] || {};
  const excludeSet = new Set(rules.exclude || []);

  // Parse all entries from config
  ALL_ENTRIES = config.countries.map(c => {
    // Extract a clean filename key from the file path: "countries/foo.webp" -> "foo"
    const fileKey = c.file.replace('countries/', '').replace('.webp', '');
    return { ...c, fileKey, regionPath: `assets/${regionId}/` };
  });

  // For vastindien: handle "!" entries and duplicates
  if (rules.bangDuplicates) {
    // Entries with "!" at end of name are zoomed-in views
    // Non-"!" entries with the same fileKey are the normal ones
    // We want to keep only ONE of each fileKey for quizzing, preferring the non-"!" version
    // But we keep ALL for rendering (they show at different positions)
    const seen = new Map();
    const quizzable = [];
    ALL_ENTRIES.forEach(e => {
      const isBang = e.name.endsWith('!');
      e.isBang = isBang;
      e.displayName = isBang ? e.name.slice(0, -1) : e.name;
      if (!seen.has(e.fileKey)) {
        seen.set(e.fileKey, e);
        if (!isBang) quizzable.push(e);
      } else if (!isBang && !quizzable.find(q => q.fileKey === e.fileKey)) {
        quizzable.push(e);
      }
    });
    // If a fileKey only has "!" entries and no non-"!" entry, add one "!" entry as quizzable
    ALL_ENTRIES.forEach(e => {
      if (e.isBang && !quizzable.find(q => q.fileKey === e.fileKey)) {
        quizzable.push(e);
      }
    });
    COUNTRIES = quizzable;
  } else {
    ALL_ENTRIES.forEach(e => {
      e.displayName = e.name;
      e.isBang = false;
    });
    COUNTRIES = ALL_ENTRIES.filter(e => !excludeSet.has(e.name));
  }

  // Map coordinate system
  mapLeft = config.mapOffset ? config.mapOffset.left : 0;
  mapTop = config.mapOffset ? config.mapOffset.top : 0;
  mapW = config.canvasWidth;
  mapH = config.canvasHeight;

  // Bolivia shape handling for sydamerika
  boliviaShapeEntry = null;
  boliviaShapeHitData = null;
  if (rules.shapes) {
    for (const [countryName, shapeInfo] of Object.entries(rules.shapes)) {
      const shapeEntry = ALL_ENTRIES.find(e => e.name === shapeInfo.shapeName);
      if (shapeEntry && countryName === 'Bolivia') {
        boliviaShapeEntry = shapeEntry;
      }
    }
  }

  // Set up the label for quiz mode
  const regionDef = REGIONS.find(r => r.id === regionId);
  const itemLabel = regionDef ? regionDef.itemLabel : 'l√§nder';
  const itemSingular = itemLabel === 'delstater' ? 'delstat' : (itemLabel === 'landskap' ? 'landskap' : 'land');
  document.getElementById('seterra-label').textContent = `Hitta detta ${itemSingular}:`;

  // Set title and map image
  document.getElementById('game-title').textContent = config.name || regionId;
  baseMap.src = `assets/${regionId}/map.webp`;

  // Wait for map to load
  await new Promise(resolve => {
    if (baseMap.complete && baseMap.naturalWidth > 0) resolve();
    else baseMap.onload = resolve;
  });

  // Reset state
  resetFullState();

  // Clear old overlays from map-wrapper (keep only base-map)
  const toRemove = mapWrapper.querySelectorAll('.country-overlay, .hover-highlight, .map-overlay');
  toRemove.forEach(el => el.remove());

  // Clear caches
  Object.keys(hitCanvases).forEach(k => delete hitCanvases[k]);
  Object.keys(hitPixelData).forEach(k => delete hitPixelData[k]);
  Object.keys(overlayEls).forEach(k => delete overlayEls[k]);
  Object.keys(hoverEls).forEach(k => delete hoverEls[k]);

  // Create overlays and load hit data
  createOverlays();
  await loadHitData();
  processHoverImages();

  // Update counts
  totalCountEl.textContent = COUNTRIES.length;
  exploredCountEl.textContent = '0';
  seterraProgressLabel.textContent = `0 / ${COUNTRIES.length}`;

  // Switch screens
  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('game-screen').style.display = '';

  // Ensure explore mode
  currentMode = 'explore';
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === 'explore'));
  document.getElementById('explore-ui').style.display = '';
  document.getElementById('seterra-ui').style.display = 'none';
  headerHint.textContent = 'Klicka p√• ett land';

  loading.classList.add('hidden');
}

function resetFullState() {
  revealed.clear();
  justRevealed.clear();
  currentHover = null;
  activeCountry = null;
  zoom = 1; panX = 0; panY = 0;
  applyTransform();
  clearInterval(seterraTimerInterval);
  seterraTarget = null;
  cursorLabel.style.display = 'none';
  infoCard.classList.remove('active');
  infoDefault.style.display = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HIT DETECTION & OVERLAYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadHitData() {
  const promises = ALL_ENTRIES.map(c => new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = c.width;
      canvas.height = c.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, c.width, c.height);
      hitCanvases[c.fileKey] = { canvas, ctx, entry: c };
      resolve();
    };
    img.onerror = resolve;
    img.src = c.regionPath + c.file;
  }));

  return Promise.all(promises);
}

function createOverlays() {
  ALL_ENTRIES.forEach(c => {
    const rules = REGION_RULES[currentRegionId] || {};
    const excludeSet = new Set(rules.exclude || []);

    // Don't create visible overlays for excluded shape entries
    if (excludeSet.has(c.name)) return;

    const img = document.createElement('img');
    img.className = 'country-overlay';
    img.src = c.regionPath + c.file;
    img.dataset.fileKey = c.fileKey;
    img.draggable = false;
    mapWrapper.appendChild(img);
    // For vastindien duplicates, we may have multiple overlays for the same fileKey
    // Use a composite key: fileKey + position
    const overlayKey = c.fileKey + '_' + c.left + '_' + c.top;
    overlayEls[overlayKey] = img;
    c._overlayKey = overlayKey;

    // Hover highlight (only for non-bang, non-excluded entries)
    if (!c.isBang) {
      const hover = document.createElement('img');
      hover.className = 'hover-highlight';
      hover.dataset.fileKey = c.fileKey;
      hover.draggable = false;

      // For Bolivia in sydamerika, use the shape for hover
      if (currentRegionId === 'sydamerika' && c.name === 'Bolivia' && boliviaShapeEntry) {
        hover.src = boliviaShapeEntry.regionPath + boliviaShapeEntry.file;
      } else {
        hover.src = c.regionPath + c.file;
      }
      mapWrapper.appendChild(hover);
      hoverEls[c.fileKey] = hover;
    }
  });

  // Add overlay (contour lines) if it exists for this region
  const overlayImg = document.createElement('img');
  overlayImg.className = 'map-overlay';
  overlayImg.draggable = false;
  overlayImg.id = 'map-overlay';
  overlayImg.src = `assets/${currentRegionId}/overlay.webp`;
  overlayImg.onerror = () => overlayImg.style.display = 'none';
  mapWrapper.appendChild(overlayImg);

  // Pre-sort countries by area (smallest first) for hit testing
  sortedCountries = [...COUNTRIES].sort((a, b) => (a.width * a.height) - (b.width * b.height));

  positionOverlays();
}

function processHoverImages() {
  const HOVER_R = 255, HOVER_G = 220, HOVER_B = 50;
  const BORDER_THRESHOLD = 150;

  // Build border mask from base map
  const mapCanvas = document.createElement('canvas');
  mapCanvas.width = mapW;
  mapCanvas.height = mapH;
  const mapCtx = mapCanvas.getContext('2d');
  mapCtx.drawImage(baseMap, 0, 0, mapW, mapH);
  const mapData = mapCtx.getImageData(0, 0, mapW, mapH).data;

  const raw = new Uint8Array(mapW * mapH);
  for (let i = 0; i < mapW * mapH; i++) {
    const mi = i * 4;
    const b = (mapData[mi] + mapData[mi + 1] + mapData[mi + 2]) / 3;
    if (b < BORDER_THRESHOLD || mapData[mi + 3] < 128) raw[i] = 1;
  }

  const borderMask = new Uint8Array(raw);
  for (let y = 0; y < mapH; y++) {
    for (let x = 0; x < mapW; x++) {
      if (borderMask[y * mapW + x]) continue;
      const i = y * mapW + x;
      if ((x > 0 && raw[i - 1]) || (x < mapW - 1 && raw[i + 1]) ||
          (y > 0 && raw[i - mapW]) || (y < mapH - 1 && raw[i + mapW])) {
        borderMask[i] = 1;
      }
    }
  }

  ALL_ENTRIES.forEach(c => {
    const rules = REGION_RULES[currentRegionId] || {};
    const excludeSet = new Set(rules.exclude || []);
    if (excludeSet.has(c.name) && c.name !== 'Bolivia Shape') return;

    const hc = hitCanvases[c.fileKey];
    if (!hc) return;

    // Cache pixel data for hit testing
    const hitData = hc.ctx.getImageData(0, 0, c.width, c.height).data;
    // Use overlayKey for unique pixel data caching
    hitPixelData[c._overlayKey || c.fileKey] = hitData;

    // For Bolivia shape, cache it separately
    if (c.name === 'Bolivia Shape' && currentRegionId === 'sydamerika') {
      boliviaShapeHitData = hitData;
      return; // don't create hover for shape entry
    }

    // Process hover image
    const hoverEl = hoverEls[c.fileKey];
    if (!hoverEl || c.isBang) return;

    // Determine hover source
    let hoverSource, hoverLeft, hoverTop, hoverW, hoverH;
    if (currentRegionId === 'sydamerika' && c.name === 'Bolivia' && boliviaShapeEntry) {
      const shapeHc = hitCanvases[boliviaShapeEntry.fileKey];
      if (shapeHc) {
        hoverSource = shapeHc.canvas;
        hoverLeft = boliviaShapeEntry.left;
        hoverTop = boliviaShapeEntry.top;
        hoverW = boliviaShapeEntry.width;
        hoverH = boliviaShapeEntry.height;
      } else {
        hoverSource = hc.canvas;
        hoverLeft = c.left; hoverTop = c.top; hoverW = c.width; hoverH = c.height;
      }
    } else {
      hoverSource = hc.canvas;
      hoverLeft = c.left; hoverTop = c.top; hoverW = c.width; hoverH = c.height;
    }

    const sx = hoverLeft - mapLeft;
    const sy = hoverTop - mapTop;

    const canvas = document.createElement('canvas');
    canvas.width = hoverW;
    canvas.height = hoverH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(hoverSource, 0, 0);

    const pixels = ctx.getImageData(0, 0, hoverW, hoverH);
    const d = pixels.data;

    for (let y = 0; y < hoverH; y++) {
      for (let x = 0; x < hoverW; x++) {
        const mx = sx + x;
        const my = sy + y;
        const ci = (y * hoverW + x) * 4;
        if (mx < 0 || mx >= mapW || my < 0 || my >= mapH || borderMask[my * mapW + mx]) {
          d[ci + 3] = 0;
        } else if (d[ci + 3] > 0) {
          d[ci] = HOVER_R;
          d[ci + 1] = HOVER_G;
          d[ci + 2] = HOVER_B;
        }
      }
    }

    ctx.putImageData(pixels, 0, 0);
    hoverEl.src = canvas.toDataURL();
  });
}

function positionOverlays() {
  const mapRect = baseMap.getBoundingClientRect();
  const wrapperRect = mapWrapper.getBoundingClientRect();
  const scale = mapRect.width / mapW;
  const offsetX = mapRect.left - wrapperRect.left;
  const offsetY = mapRect.top - wrapperRect.top;

  ALL_ENTRIES.forEach(c => {
    const rules = REGION_RULES[currentRegionId] || {};
    const excludeSet = new Set(rules.exclude || []);
    if (excludeSet.has(c.name)) return;

    const relLeft = (c.left - mapLeft) * scale;
    const relTop = (c.top - mapTop) * scale;
    const relW = c.width * scale;
    const relH = c.height * scale;

    const oEl = overlayEls[c._overlayKey];
    if (oEl) {
      oEl.style.left = (offsetX + relLeft) + 'px';
      oEl.style.top = (offsetY + relTop) + 'px';
      oEl.style.width = relW + 'px';
      oEl.style.height = relH + 'px';
    }

    const hEl = hoverEls[c.fileKey];
    if (hEl && !c.isBang) {
      if (currentRegionId === 'sydamerika' && c.name === 'Bolivia' && boliviaShapeEntry) {
        const bRelLeft = (boliviaShapeEntry.left - mapLeft) * scale;
        const bRelTop = (boliviaShapeEntry.top - mapTop) * scale;
        const bRelW = boliviaShapeEntry.width * scale;
        const bRelH = boliviaShapeEntry.height * scale;
        hEl.style.left = (offsetX + bRelLeft) + 'px';
        hEl.style.top = (offsetY + bRelTop) + 'px';
        hEl.style.width = bRelW + 'px';
        hEl.style.height = bRelH + 'px';
      } else {
        hEl.style.left = (offsetX + relLeft) + 'px';
        hEl.style.top = (offsetY + relTop) + 'px';
        hEl.style.width = relW + 'px';
        hEl.style.height = relH + 'px';
      }
    }
  });

  const overlayEl = document.getElementById('map-overlay');
  if (overlayEl) {
    overlayEl.style.left = offsetX + 'px';
    overlayEl.style.top = offsetY + 'px';
    overlayEl.style.width = mapRect.width + 'px';
    overlayEl.style.height = mapRect.height + 'px';
  }
}

function hitTest(clientX, clientY) {
  const mapRect = baseMap.getBoundingClientRect();
  const scale = mapW / mapRect.width;
  const absX = (clientX - mapRect.left) * scale + mapLeft;
  const absY = (clientY - mapRect.top) * scale + mapTop;

  for (const c of sortedCountries) {
    // Bolivia shape special handling
    if (currentRegionId === 'sydamerika' && c.name === 'Bolivia' && boliviaShapeEntry && boliviaShapeHitData) {
      const lx = Math.round(absX - boliviaShapeEntry.left);
      const ly = Math.round(absY - boliviaShapeEntry.top);
      if (lx < 0 || ly < 0 || lx >= boliviaShapeEntry.width || ly >= boliviaShapeEntry.height) continue;
      if (boliviaShapeHitData[((ly * boliviaShapeEntry.width + lx) * 4) + 3] > 30) return c;
    } else {
      const lx = Math.round(absX - c.left);
      const ly = Math.round(absY - c.top);
      if (lx < 0 || ly < 0 || lx >= c.width || ly >= c.height) continue;
      const data = hitPixelData[c._overlayKey || c.fileKey];
      if (!data) continue;
      if (data[((ly * c.width + lx) * 4) + 3] > 30) return c;
    }
  }
  return null;
}

function revealCountry(c) {
  const el = overlayEls[c._overlayKey];
  if (el) { el.classList.remove('flash-wrong', 'hint-blink', 'hovered'); el.classList.add('visible'); }

  // Also reveal any duplicate overlays (for vastindien "!" entries with same fileKey)
  if (REGION_RULES[currentRegionId]?.bangDuplicates) {
    ALL_ENTRIES.filter(e => e.fileKey === c.fileKey).forEach(e => {
      const dupeEl = overlayEls[e._overlayKey];
      if (dupeEl) { dupeEl.classList.remove('flash-wrong', 'hint-blink', 'hovered'); dupeEl.classList.add('visible'); }
    });
  }

  revealed.add(c.fileKey);
  justRevealed.add(c.fileKey);
  const hoverEl = hoverEls[c.fileKey];
  if (hoverEl) hoverEl.classList.remove('active');
}

function flashWrong(c) {
  const el = overlayEls[c._overlayKey];
  if (!el || revealed.has(c.fileKey)) return;
  const hoverEl = hoverEls[c.fileKey];
  if (hoverEl) hoverEl.classList.remove('active');
  el.classList.add('flash-wrong');
  setTimeout(() => { el.classList.remove('flash-wrong'); }, 1200);
}

function blinkHint(c) {
  const el = overlayEls[c._overlayKey];
  if (!el || revealed.has(c.fileKey)) return;
  el.classList.remove('hint-blink');
  void el.offsetWidth;
  el.classList.add('hint-blink');
  el.addEventListener('animationend', () => el.classList.remove('hint-blink'), { once: true });
}

function resetOverlays() {
  document.querySelectorAll('.country-overlay').forEach(el => {
    el.classList.remove('visible', 'flash-wrong', 'hint-blink', 'hovered');
  });
  revealed.clear();
  justRevealed.clear();
  currentHover = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHover(e) {
  const hit = hitTest(e.clientX, e.clientY);
  const newHover = hit ? hit.fileKey : null;
  if (newHover !== currentHover) {
    if (currentHover) {
      const oldHoverEl = hoverEls[currentHover];
      if (oldHoverEl) oldHoverEl.classList.remove('active');
      // Un-hover all overlays for this fileKey
      ALL_ENTRIES.filter(e2 => e2.fileKey === currentHover).forEach(e2 => {
        const oEl = overlayEls[e2._overlayKey];
        if (oEl) oEl.classList.remove('hovered');
      });
      justRevealed.delete(currentHover);
    }
    if (newHover && !justRevealed.has(newHover)) {
      if (revealed.has(newHover)) {
        ALL_ENTRIES.filter(e2 => e2.fileKey === newHover).forEach(e2 => {
          const oEl = overlayEls[e2._overlayKey];
          if (oEl) oEl.classList.add('hovered');
        });
      } else {
        const newHoverEl = hoverEls[newHover];
        if (newHoverEl) {
          // Don't show hover if flash-wrong is active
          const anyFlashing = ALL_ENTRIES.some(e2 => e2.fileKey === newHover && overlayEls[e2._overlayKey]?.classList.contains('flash-wrong'));
          if (!anyFlashing) newHoverEl.classList.add('active');
        }
      }
    }
    currentHover = newHover;
  }

  if (currentMode === 'seterra' && seterraTarget && !seterraLocked) {
    cursorLabel.style.left = e.clientX + 'px';
    cursorLabel.style.top = e.clientY + 'px';
  }

  if (currentMode === 'explore' && cursorLabel.classList.contains('explore-tooltip')) {
    cursorLabel.style.left = e.clientX + 'px';
    cursorLabel.style.top = e.clientY + 'px';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG & CLICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isDragging = false, didDrag = false;
let dragStartX = 0, dragStartY = 0, panStartX = 0, panStartY = 0;

function onPointerDown(e) {
  if (e.button !== 0) return;
  if (e.target.closest('.zoom-controls')) return;
  e.preventDefault();
  mapPanel.setPointerCapture(e.pointerId);
  isDragging = true;
  didDrag = false;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  panStartX = panX;
  panStartY = panY;
  mapWrapper.classList.add('dragging');
}

function onPointerMove(e) {
  if (currentMode === 'seterra' && seterraTarget) {
    cursorLabel.style.left = e.clientX + 'px';
    cursorLabel.style.top = e.clientY + 'px';
  } else if (currentMode === 'explore' && cursorLabel.style.display === 'block') {
    cursorLabel.style.left = e.clientX + 'px';
    cursorLabel.style.top = e.clientY + 'px';
  }
  if (!isDragging) {
    if (!hoverRafPending) {
      hoverRafPending = true;
      requestAnimationFrame(() => { hoverRafPending = false; updateHover(e); });
    }
    return;
  }
  const dx = e.clientX - dragStartX, dy = e.clientY - dragStartY;
  if (Math.abs(dx) > 3 || Math.abs(dy) > 3) didDrag = true;
  if (didDrag) {
    panX = panStartX + dx;
    panY = panStartY + dy;
    clampPan();
    applyTransform();
  }
}

function onPointerUp(e) {
  mapWrapper.classList.remove('dragging');
  if (!isDragging) return;
  isDragging = false;
  if (!didDrag) {
    const hit = hitTest(e.clientX, e.clientY);
    if (hit) handleClick(hit, e);
  }
}

function handleClick(c, e) {
  if (currentMode === 'explore') exploreClick(c, e);
  else seterraClick(c);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPLORE MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showInfoCard(c) {
  activeCountry = c.fileKey;
  const displayName = c.displayName || c.name;
  infoName.textContent = displayName;
  infoShape.src = c.regionPath + c.file;

  const assocs = IMAGE_ASSOCIATIONS[currentRegionId];
  const assoc = assocs ? assocs[c.fileKey] : null;
  const descs = DESCRIPTIONS[currentRegionId];
  const desc = descs ? descs[c.fileKey] : null;

  let html = '';
  if (assoc) html += `<div class="assoc-box">${escHtml(assoc)}</div>`;
  if (desc) html += escHtml(desc);
  infoDesc.innerHTML = html || `<em style="color:#4a6a82">Ingen beskrivning tillg√§nglig √§nnu.</em>`;

  infoDefault.style.display = 'none';
  infoCard.classList.add('active');
}

function exploreClick(c, e) {
  if (revealed.has(c.fileKey)) {
    // Un-reveal all overlays for this fileKey
    ALL_ENTRIES.filter(e2 => e2.fileKey === c.fileKey).forEach(e2 => {
      const oEl = overlayEls[e2._overlayKey];
      if (oEl) oEl.classList.remove('visible', 'hovered');
    });
    revealed.delete(c.fileKey);
  } else {
    revealCountry(c);
  }
  showInfoCard(c);

  if (e) {
    clearTimeout(exploreTooltipTimer);
    cursorLabel.textContent = c.displayName || c.name;
    cursorLabel.classList.add('explore-tooltip');
    cursorLabel.style.left = e.clientX + 'px';
    cursorLabel.style.top = e.clientY + 'px';
    cursorLabel.style.display = 'block';
    exploreTooltipTimer = setTimeout(hideExploreTooltip, 1000);
  }
  exploredCountEl.textContent = revealed.size;
}

function hideExploreTooltip() {
  clearTimeout(exploreTooltipTimer);
  cursorLabel.style.display = 'none';
  cursorLabel.classList.remove('explore-tooltip');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETERRA MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function startSeterra() {
  resetOverlays();
  seterraQueue = shuffle([...COUNTRIES]);
  seterraCorrect = 0;
  seterraWrong = 0;
  seterraTotal = COUNTRIES.length;
  seterraLocked = false;
  seterraTargetMisses = 0;
  seterraIsRetry = false;
  seterraMissedCountries.clear();
  seterraStartTime = Date.now();

  seterraGame.classList.add('active');
  seterraDone.classList.remove('active');
  cursorLabel.style.display = 'block';

  updateSeterraUI();
  nextSeterraTarget();

  clearInterval(seterraTimerInterval);
  seterraTimerInterval = setInterval(updateSeterraTimer, 500);
}

function startSeterraRetry() {
  const missedList = COUNTRIES.filter(c => seterraMissedCountries.has(c.fileKey));
  if (missedList.length === 0) return;

  resetOverlays();
  COUNTRIES.forEach(c => {
    if (!seterraMissedCountries.has(c.fileKey)) revealCountry(c);
  });

  seterraQueue = shuffle([...missedList]);
  seterraCorrect = 0;
  seterraWrong = 0;
  seterraTotal = missedList.length;
  seterraLocked = false;
  seterraTargetMisses = 0;
  seterraIsRetry = true;
  seterraMissedCountries.clear();
  seterraStartTime = Date.now();

  seterraGame.classList.add('active');
  seterraDone.classList.remove('active');
  cursorLabel.style.display = 'block';

  updateSeterraUI();
  nextSeterraTarget();

  clearInterval(seterraTimerInterval);
  seterraTimerInterval = setInterval(updateSeterraTimer, 500);
}

function nextSeterraTarget() {
  if (seterraQueue.length === 0) { endSeterra(); return; }
  seterraTarget = seterraQueue.pop();
  seterraTargetMisses = 0;
  const name = seterraTarget.displayName || seterraTarget.name;
  seterraTargetName.textContent = name;
  cursorLabel.textContent = name;
  seterraFeedback.className = 'seterra-feedback';
  seterraFeedback.innerHTML = '';
}

function seterraClick(c) {
  if (!seterraTarget || seterraLocked) return;

  if (c.fileKey === seterraTarget.fileKey) {
    seterraCorrect++;
    seterraTargetMisses = 0;
    revealCountry(c);
    seterraFeedback.className = 'seterra-feedback correct-fb';
    const assocs = IMAGE_ASSOCIATIONS[currentRegionId];
    const assoc = assocs ? assocs[c.fileKey] : null;
    const descs = DESCRIPTIONS[currentRegionId];
    const desc = descs ? descs[c.fileKey] : '';
    const displayName = c.displayName || c.name;
    seterraFeedback.innerHTML = `<div class="fb-title">R√§tt! ${escHtml(displayName)}</div>${assoc ? `<div class="assoc-box">${escHtml(assoc)}</div>` : ''}${desc ? `<div class="fb-desc">${escHtml(desc)}</div>` : ''}`;
    updateSeterraUI();
    nextSeterraTarget();
  } else {
    seterraWrong++;
    seterraTargetMisses++;
    seterraMissedCountries.add(seterraTarget.fileKey);
    flashWrong(c);
    seterraFeedback.className = 'seterra-feedback wrong-fb';
    const displayName = c.displayName || c.name;
    const assocs = IMAGE_ASSOCIATIONS[currentRegionId];
    const assoc = assocs ? assocs[c.fileKey] : null;
    const descs = DESCRIPTIONS[currentRegionId];
    const desc = descs ? descs[c.fileKey] : '';
    seterraFeedback.innerHTML = `<div class="fb-title">Fel ‚Äì det var ${escHtml(displayName)}</div>${assoc ? `<div class="assoc-box">${escHtml(assoc)}</div>` : ''}${desc ? `<div class="fb-desc">${escHtml(desc)}</div>` : ''}`;
    updateSeterraUI();

    if (seterraTargetMisses >= 3) blinkHint(seterraTarget);

    seterraLocked = true;
    setTimeout(() => { seterraLocked = false; }, 600);
  }
}

function updateSeterraUI() {
  const totalClicks = seterraCorrect + seterraWrong;
  const score = totalClicks > 0 ? Math.round((seterraCorrect / totalClicks) * 100) : 100;
  seterraScoreEl.textContent = score + '%';
  seterraCorrectEl.textContent = seterraCorrect;
  seterraWrongEl.textContent = seterraWrong;
  const pct = Math.round((seterraCorrect / seterraTotal) * 100);
  seterraBar.style.width = pct + '%';
  seterraProgressLabel.textContent = `${seterraCorrect} / ${seterraTotal}`;
}

function updateSeterraTimer() {
  const elapsed = Math.floor((Date.now() - seterraStartTime) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  seterraTimeEl.textContent = `${m}:${s.toString().padStart(2, '0')}`;
}

function endSeterra() {
  clearInterval(seterraTimerInterval);
  updateSeterraTimer();
  seterraTarget = null;
  cursorLabel.style.display = 'none';

  const totalClicks = seterraCorrect + seterraWrong;
  const score = totalClicks > 0 ? Math.round((seterraCorrect / totalClicks) * 100) : 100;
  seterraElapsed = Math.floor((Date.now() - seterraStartTime) / 1000);
  const m = Math.floor(seterraElapsed / 60);
  const s = seterraElapsed % 60;

  seterraGame.classList.remove('active');
  seterraDone.classList.add('active');
  document.getElementById('seterra-final-score').textContent = score + '%';
  document.getElementById('seterra-final-detail').innerHTML =
    `${seterraCorrect} av ${seterraTotal}<br>${seterraWrong} felklick<br>Tid: ${m}:${s.toString().padStart(2, '0')}`;

  const retryBtn = document.getElementById('seterra-retry');
  if (seterraMissedCountries.size > 0) {
    retryBtn.style.display = '';
    retryBtn.textContent = `√ñva p√• felaktiga (${seterraMissedCountries.size} st)`;
  } else {
    retryBtn.style.display = 'none';
  }

  document.getElementById('hs-form').style.display = 'none';
  document.getElementById('hs-saved-msg').style.display = 'none';

  if (!seterraIsRetry) showNameModal(score, m, s);
  renderHighscores();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HIGH SCORES (per region)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hsKey() { return `hs-${currentRegionId}`; }

function getHighscores() {
  try { return JSON.parse(localStorage.getItem(hsKey())) || []; }
  catch { return []; }
}

function saveHighscore(name, score, time, wrong) {
  const list = getHighscores();
  const entry = { name, score, time, wrong, date: Date.now() };
  list.push(entry);
  list.sort((a, b) => b.score - a.score || a.time - b.time);
  if (list.length > 10) list.length = 10;
  localStorage.setItem(hsKey(), JSON.stringify(list));
  return entry;
}

function renderHighscores(highlightEntry) {
  const list = getHighscores();
  const container = document.getElementById('highscore-list');
  if (list.length === 0) {
    container.innerHTML = '<div class="hs-empty">Inga sparade resultat √§nnu.</div>';
    return;
  }
  let html = '<h3>Topplista</h3><table class="hs-table"><thead><tr><th>#</th><th>Namn</th><th>Po√§ng</th><th>Tid</th></tr></thead><tbody>';
  list.forEach((e, i) => {
    const m = Math.floor(e.time / 60);
    const s = e.time % 60;
    const isCurrent = highlightEntry && e.date === highlightEntry.date && e.name === highlightEntry.name;
    html += `<tr class="${isCurrent ? 'hs-current' : ''}"><td>${i + 1}</td><td>${escHtml(e.name)}</td><td>${e.score}%</td><td>${m}:${s.toString().padStart(2, '0')}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function escHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAME POPUP MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNameModal(score, m, s) {
  document.getElementById('modal-score').textContent = score + '%';
  document.getElementById('modal-detail').innerHTML =
    `${seterraCorrect} av ${seterraTotal} &bull; ${seterraWrong} fel &bull; ${m}:${s.toString().padStart(2, '0')}`;
  modalNameInput.value = '';
  nameModalOverlay.classList.add('active');
  setTimeout(() => modalNameInput.focus(), 100);
}

function closeNameModal() { nameModalOverlay.classList.remove('active'); }

document.getElementById('modal-save').addEventListener('click', () => {
  const name = modalNameInput.value.trim();
  if (!name) { modalNameInput.focus(); return; }
  const totalClicks = seterraCorrect + seterraWrong;
  const score = totalClicks > 0 ? Math.round((seterraCorrect / totalClicks) * 100) : 100;
  const entry = saveHighscore(name, score, seterraElapsed, seterraWrong);
  closeNameModal();
  renderHighscores(entry);
});

modalNameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('modal-save').click();
});

document.getElementById('modal-skip').addEventListener('click', closeNameModal);
nameModalOverlay.addEventListener('click', (e) => { if (e.target === nameModalOverlay) closeNameModal(); });

document.getElementById('hs-save').addEventListener('click', () => {
  const name = document.getElementById('hs-name').value.trim();
  if (!name) return;
  const totalClicks = seterraCorrect + seterraWrong;
  const score = totalClicks > 0 ? Math.round((seterraCorrect / totalClicks) * 100) : 100;
  const entry = saveHighscore(name, score, seterraElapsed, seterraWrong);
  document.getElementById('hs-form').style.display = 'none';
  document.getElementById('hs-saved-msg').style.display = '';
  renderHighscores(entry);
});

document.getElementById('hs-name').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('hs-save').click();
});

document.getElementById('seterra-restart').addEventListener('click', startSeterra);
document.getElementById('seterra-retry').addEventListener('click', startSeterraRetry);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMode(mode) {
  if (mode === currentMode) return;
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));

  if (mode === 'explore') {
    document.getElementById('explore-ui').style.display = '';
    document.getElementById('seterra-ui').style.display = 'none';
    hideExploreTooltip();
    clearInterval(seterraTimerInterval);
    seterraTarget = null;
    headerHint.textContent = 'Klicka p√• ett land';
    resetOverlays();
    activeCountry = null;
    infoCard.classList.remove('active');
    infoDefault.style.display = '';
    exploredCountEl.textContent = '0';
  } else {
    document.getElementById('explore-ui').style.display = 'none';
    document.getElementById('seterra-ui').style.display = '';
    headerHint.textContent = 'Klicka d√§r du tror landet √§r!';
    startSeterra();
  }
}

document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => switchMode(btn.dataset.mode));
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACK BUTTON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('back-btn').addEventListener('click', () => {
  clearInterval(seterraTimerInterval);
  seterraTarget = null;
  cursorLabel.style.display = 'none';
  document.getElementById('game-screen').style.display = 'none';
  document.getElementById('start-screen').style.display = '';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZOOM & TRANSFORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyTransform() {
  mapWrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
  zoomLevelEl.textContent = Math.round(zoom * 100) + '%';
}

function clampPan() {
  const baseW = baseMap.offsetWidth, baseH = baseMap.offsetHeight;
  const panelW = mapPanel.clientWidth, panelH = mapPanel.clientHeight;
  const scaledW = baseW * zoom, scaledH = baseH * zoom;
  const maxX = Math.max(0, (scaledW - panelW) / 2 + panelW * 0.5);
  const maxY = Math.max(0, (scaledH - panelH) / 2 + panelH * 0.5);
  panX = Math.max(-maxX, Math.min(maxX, panX));
  panY = Math.max(-maxY, Math.min(maxY, panY));
}

function setZoom(newZoom, cursorX, cursorY) {
  const oldZoom = zoom;
  zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
  if (zoom === oldZoom) return;
  if (cursorX !== undefined && cursorY !== undefined) {
    const r = mapPanel.getBoundingClientRect();
    const cx = cursorX - r.left - r.width / 2;
    const cy = cursorY - r.top - r.height / 2;
    panX = cx - ((cx - panX) / oldZoom) * zoom;
    panY = cy - ((cy - panY) / oldZoom) * zoom;
  }
  clampPan();
  applyTransform();
}

function onWheel(e) {
  e.preventDefault();
  setZoom(zoom * (e.deltaY > 0 ? 0.9 : 1.1), e.clientX, e.clientY);
}

document.getElementById('zoom-in').addEventListener('click', () => setZoom(zoom * 1.3));
document.getElementById('zoom-out').addEventListener('click', () => setZoom(zoom / 1.3));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JONAS HIGH-FIVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const jonasImg = document.getElementById('jonas-img');
const highfiveCountEl = document.getElementById('highfive-count');
const highfiveAudio = new Audio('high_five.wav');
let highfiveCount = parseInt(localStorage.getItem('highfive-count') || '0', 10);
highfiveCountEl.textContent = highfiveCount;

jonasImg.addEventListener('click', () => {
  highfiveCount++;
  localStorage.setItem('highfive-count', highfiveCount);
  highfiveCountEl.textContent = highfiveCount;
  highfiveAudio.currentTime = 0;
  highfiveAudio.play();
  jonasImg.src = 'Jonas_2.webp';
  setTimeout(() => { jonasImg.src = 'Jonas_1.webp'; }, 1000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POINTER EVENTS SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
mapPanel.addEventListener('pointerdown', onPointerDown);
mapPanel.addEventListener('pointermove', onPointerMove);
mapPanel.addEventListener('pointerup', onPointerUp);
mapPanel.addEventListener('pointercancel', onPointerUp);
mapPanel.addEventListener('wheel', onWheel, { passive: false });
window.addEventListener('resize', () => { if (currentRegionId) positionOverlays(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
buildStartScreen();
</script>

</body>
</html>
